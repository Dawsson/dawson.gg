---
import BlogLayout from "@/layouts/blog.astro";
import Nav from "@/components/nav.astro";
import { fetchNoteByPath } from "@/lib/github.ts";
import { renderMarkdown } from "@/lib/render.ts";
import type { Bindings, ShareLink } from "@/lib/types.ts";

const env = Astro.locals.runtime.env as Bindings;
const id = Astro.params.id;

function stripLeadingH1(md: string): string {
  return md.replace(/^# .+\n*/m, "");
}

const raw = await env.CACHE.get(`share:${id}`);
if (!raw) {
  return new Response(null, { status: 404 });
}

const share = JSON.parse(raw) as ShareLink;
const note = await fetchNoteByPath(env, share.path);
if (!note) {
  return new Response(null, { status: 404 });
}

const body = stripLeadingH1(note.content);
const rendered = renderMarkdown(body);
---

<BlogLayout title={note.title}>
  <Nav />
  <article>
    <header class="note-header">
      <h1>{note.title}</h1>
      {note.frontmatter.created && (
        <time>{String(note.frontmatter.created)}</time>
      )}
    </header>
    <Fragment set:html={rendered} />
  </article>
</BlogLayout>
